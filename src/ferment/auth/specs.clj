(ns

    ferment.auth.specs

  (:refer-clojure :exclude [parse-long uuid random-uuid])

  (:require
   [clojure.spec.alpha       :as        s]
   [io.randomseed.utils      :refer  :all]))

(s/def :ferment.auth/encrypt-fn ifn?)
(s/def :ferment.auth/check-fn   ifn?)
(s/def :ferment.auth/wait-fn    ifn?)

;; Single password (component of password entry),
;; plain and encrypted version

(s/def :ferment.auth.plain/password
 (s/or :string string? :bytes bytes?))

(s/def :ferment.auth.encrypted/password
  bytes?)

;; Handler identifier (part of a password entry)

(s/def :ferment.auth.password/handler-id
  qualified-symbol?)

;; Shared part of a password entry (after splitting)

(s/def :ferment.auth.password/shared
  (s/keys :req-un [:ferment.auth.password/handler-id]))

;; Intrinsic part of a password entry (after splitting)

(s/def :ferment.auth.password/intrinsic
  map?)

;; Dual password entry (shared and intrinsic parts as a map)

(s/def :ferment.auth.password/dual
  (s/keys :req-un [:ferment.auth.password/shared
                   :ferment.auth.password/intrinsic]))

;; Password entry

(s/def :ferment.auth/password
  (s/keys :req-un [:ferment.auth.password/handler-id]))

;; Password chain (sequence of password entries)

(s/def :ferment.auth.password-chain/last
  (s/keys :req-un [:ferment.auth.password/handler-id
                   :ferment.auth.encrypted/password]))

(s/def :ferment.auth/password-chain
  (s/and (s/coll-of :ferment.auth/password)
         #(s/valid? :ferment.auth.password-chain/last (last %))))

(s/def :ferment.auth.password-chain/shared
  (s/coll-of :ferment.auth.password/shared))

(s/def :ferment.auth.password-chain/intrinsic
  (s/and (s/coll-of :ferment.auth.password/intrinsic)
         #(s/valid? :ferment.auth.password-chain/last (last %))))

(s/def :ferment.auth.password-chain/dual
  (s/keys :req-un [:ferment.auth.password-chain/shared
                   :ferment.auth.password-chain/intrinsic]))

;; Settings are generated by parsing a configuration

(s/def :ferment.auth.settings.cipher.handler/id
  qualified-symbol?)

;; Cipher is a map of parameters used to create a password entry
;; during the encryption process. Multiple ciphers create a chain.

(s/def :ferment.auth.settings.cipher/name
  (s/or :string string? :identifier ident?))

(s/def :ferment.auth.settings.cipher/handler
  (s/keys :req-un [:ferment.auth/check-fn
                   :ferment.auth/encrypt-fn
                   :ferment.auth.settings.cipher.handler/id]))

(s/def :ferment.auth.settings/cipher
  (s/keys :req-un [:ferment.auth/check-fn
                   :ferment.auth/encrypt-fn
                   :ferment.auth.settings.cipher/handler
                   :ferment.auth.settings.cipher/name]
          :opt-un [:ferment.auth.settings.cipher/salt-charset
                   :ferment.auth.settings.cipher/salt-length
                   :ferment.auth.settings.cipher/salt-prefix
                   :ferment.auth.settings.cipher/salt-suffix]))

(s/def :ferment.auth.settings.cipher/shared
  (s/keys :req-un [:ferment.auth.settings.cipher/handler-id]))

(s/def :ferment.auth.settings.cipher/intrinsic
  map?)

(s/def :ferment.auth.settings.cipher/dual
  (s/keys :req-un [:ferment.auth.settings.cipher/shared
                   :ferment.auth.settings.cipher/intrinsic]))

(s/def :ferment.auth.settings/suite
  (s/coll-of :ferment.auth.settings/cipher))

(s/def :ferment.auth.settings.suite/shared
  (s/coll-of :ferment.auth.settings.cipher/shared))

(s/def :ferment.auth.settings.suite/intrinsic
  (s/coll-of :ferment.auth.settings.cipher/intrinsic))

(s/def :ferment.auth.settings.suite/dual
  (s/keys :req-un [:ferment.auth.settings.suite/shared
                   :ferment.auth.settings.suite/intrinsic]))

(s/def :ferment.auth.settings.cipher/salt-charset (s/nilable vector?))
(s/def :ferment.auth.settings.cipher/salt-prefix  (s/nilable string?))
(s/def :ferment.auth.settings.cipher/salt-suffix  (s/nilable string?))
(s/def :ferment.auth.settings.cipher/salt-length  (s/nilable nat-int?))

(s/def :ferment.auth.pwd/settings
  (s/keys :req-un [:ferment.auth.settings/suite]
          :opt-un [:ferment.auth/wait-fn]))

(s/def :ferment.auth.settings/generic
  (s/keys :opt-un [:ferment.auth/wait-fn]))

;; Authentication Configuration
;;
;; Data from configuration file which describes authentication parameters.
;; It also contains the :suite key which is a place for configuration
;; of ciphers. The ciphers are then used to process plain passwords
;; and produce encrypted versions represented as password chains.

(s/def :ferment.auth.config/wait        (s/nilable (s/and number? (s/or :pos pos? :zero zero?))))
(s/def :ferment.auth.config/wait-min    (s/nilable (s/and number? (s/or :pos pos? :zero zero?))))
(s/def :ferment.auth.config/wait-max    (s/nilable (s/and number? pos?)))
(s/def :ferment.auth.config/wait-nouser (s/nilable (s/or :pos pos? :zero zero?)))

(s/def :ferment.auth.config.cipher/handler      qualified-symbol?)
(s/def :ferment.auth.config.cipher/name         (s/or :string string? :identifier ident?))
(s/def :ferment.auth.config.cipher/salt-charset (s/nilable string?))
(s/def :ferment.auth.config.cipher/salt-prefix  (s/nilable string?))
(s/def :ferment.auth.config.cipher/salt-suffix  (s/nilable string?))
(s/def :ferment.auth.config.cipher/salt-length  (s/nilable nat-int?))

(s/def :ferment.auth.config/cipher
  (s/keys :req-un [:ferment.auth.config.cipher/handler
                   :ferment.auth.config.cipher/name]
          :opt-un [:ferment.auth.config.cipher/salt-charset
                   :ferment.auth.config.cipher/salt-length
                   :ferment.auth.config.cipher/salt-prefix
                   :ferment.auth.config.cipher/salt-suffix]))

(s/def :ferment.auth.config/suite
  (s/coll-of :ferment.auth.config/cipher :kind vector?))

(s/def :ferment.auth/config
  (s/keys :req-un [:ferment.auth.config/suite]
          :opt-un [:ferment.auth.config/wait
                   :ferment.auth.config/wait-min
                   :ferment.auth.config/wait-max
                   :ferment.auth.config/wait-nouser]))

(s/def :ferment.auth/crypto-entry
  (s/or :password        :ferment.auth/password
        :settings-cipher :ferment.auth.settings/cipher
        :config-cipher   :ferment.auth.config/cipher))

(s/def :ferment.auth/crypto-suite
  (s/or :password-suite :ferment.auth/password-chain
        :settings-suite :ferment.auth.settings/suite
        :config-suite   :ferment.auth.config/suite))
