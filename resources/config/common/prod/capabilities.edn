{

 ;; Capabilities as separate top-level keys (flattened registry branch)
 :ferment.caps.registry/llm-voice
 {:cap/id        :llm/voice
  :cap/kind      :llm
  :cap/intents   #{:text/respond}
  :cap/can-produce #{:value}
  :cap/effects-allowed #{:none}
  :dispatch/role :voice
  :dispatch/model-key :ferment.model/voice
  :io/in-schema  :req/text
  :io/out-schema :res/text
  :dispatch/tag  :voice}

 :ferment.caps.registry/llm-code
 {:cap/id        :llm/code
  :cap/kind      :llm
  :cap/intents   #{:code/generate :code/patch :code/explain :code/review}
  :cap/can-produce #{:value :plan}
  :cap/effects-allowed #{:none}
  :dispatch/role :coder
  :dispatch/model-key :ferment.model/coding
  :io/in-schema  :req/code
  :io/out-schema :res/patch+tests
  :dispatch/tag  :code}

 :ferment.caps.registry/llm-solver
 {:cap/id        :llm/solver
  :cap/kind      :llm
  :cap/intents   #{:problem/solve}
  :cap/can-produce #{:value :plan}
  :cap/effects-allowed #{:none}
  :dispatch/role :solver
  :dispatch/model-key :ferment.model/solver
  :io/in-schema  :req/problem
  :io/out-schema :res/problem
  :dispatch/tag  :solver}

 :ferment.caps.registry/llm-meta
 {:cap/id        :llm/meta
  :cap/kind      :llm
  :cap/intents   #{:route/decide :context/summarize}
  :cap/can-produce #{:value :plan}
  :cap/effects-allowed #{:none}
  :dispatch/role :router
  :dispatch/model-key :ferment.model/meta
  :io/in-schema  :req/meta
  :io/out-schema :res/meta
  :dispatch/tag  :meta}

 :ferment.caps.registry/llm-judge
 {:cap/id        :llm/judge
  :cap/kind      :llm
  :cap/intents   #{:eval/grade}
  :cap/can-produce #{:value}
  :cap/effects-allowed #{:none}
  :dispatch/role :router
  :dispatch/model-key :ferment.model/meta
  :io/in-schema  :req/eval
  :io/out-schema :res/eval
  :dispatch/tag  :judge}

 :ferment.caps.registry/llm-mock
 {:cap/id        :llm/mock
  :cap/kind      :mock
  :cap/intents   #{:route/decide :context/summarize :text/respond
                   :problem/solve
                   :code/generate :code/patch :code/explain :code/review
                   :eval/grade}
  :cap/can-produce #{:value :plan}
  :cap/effects-allowed #{:none}
  :dispatch/role :router
  :dispatch/model-key :ferment.model/meta
  :io/in-schema  :req/any
  :io/out-schema :res/any
  :dispatch/tag  :mock}

 ;; Optional aggregate list for consumers preferring a single entrypoint.
 :ferment.caps/registry
 [#ref :ferment.caps.registry/llm-voice
  #ref :ferment.caps.registry/llm-code
  #ref :ferment.caps.registry/llm-solver
  #ref :ferment.caps.registry/llm-meta
  #ref :ferment.caps.registry/llm-judge
  #ref :ferment.caps.registry/llm-mock]

 ;; Declarative intent routing
 :ferment.caps/routing
 {:intent->cap {:route/decide      :llm/meta
                :context/summarize :llm/meta
                :text/respond      :llm/voice
                :problem/solve     :llm/solver
                :code/generate     :llm/code
                :code/patch        :llm/code
                :code/explain      :llm/code
                :code/review       :llm/code
                :eval/grade        :llm/judge}
  :policy      :quality-aware
  :switch-on   #{:schema/invalid :format/drift :eval/low-score}
  :retry       {:same-cap-max 1
                :fallback-max 1}
  :fallback    [:llm/solver :llm/code :llm/meta :llm/judge :llm/mock]
  :checks      [:schema-valid :tests-pass]}

 ;; Runtime/profile policy knobs
 :ferment.caps/profiles
 {:default {:llm/mode :live}
  :test    {:llm/mode :mock}
  :mini    {:llm/mode :live}}

}
