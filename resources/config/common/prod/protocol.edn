{

 :ferment.protocol/default
 {:proto/version          1
  :meta-language          :edn
  :transport/content-type :application/edn
  :envelope/request       {:required [:proto :trace :task :input]
                           :optional [:constraints :done :context :budget :effects]}
  :envelope/response      {:required-one-of [:result :error]}

  :intents                {:route/decide      {:in-schema :req/route
                                               :out-schema :res/route
                                               :result/contract {:type :plan
                                                                 :contract/kind :route/solver->voice}}
                           :context/summarize {:in-schema :req/context
                                               :out-schema :res/context-summary}
                           :text/respond      {:in-schema :req/text
                                               :out-schema :res/text
                                               :constraints {:max-chars 1200}
                                               :system "Jesteś VOICE w projekcie Ferment (Clojure: orkiestrator modeli AI, routing, kontrakty).\nOdpowiadaj po polsku, krótko i rzeczowo.\nTermin 'Ferment' interpretuj jako ten projekt, nie jako funkcję/bibliotekę JavaScript.\nNie ujawniaj wewnętrznego rozumowania i nigdy nie zwracaj znaczników <think>.\nJeśli kontekst jest niejednoznaczny, poproś o doprecyzowanie zamiast zgadywać."}
                           :problem/solve     {:in-schema :req/problem
                                               :out-schema :res/problem}
                           :code/generate     {:in-schema :req/code
                                               :out-schema :res/code}
                           :code/patch        {:in-schema :req/code
                                               :out-schema :res/patch+tests}
                           :code/explain      {:in-schema :req/code
                                               :out-schema :res/explanation}
                           :code/review       {:in-schema :req/code
                                               :out-schema :res/review}
                           :eval/grade        {:in-schema :req/eval
                                               :out-schema :res/eval
                                               :result/contract {:type :value
                                                                 :required [:score]
                                                                 :score/range [0.0 1.0]}}}

  :policy/checks          {:schema-valid         :builtin/schema-valid
                           :tests-pass           :builtin/tests-pass
                           :no-hallucinated-apis :builtin/no-hallucinated-apis
                           :no-list-expansion    :builtin/no-list-expansion}

  :policy/default         {:done {:must      #{:schema-valid}
                                   :should    #{:tests-pass :no-hallucinated-apis}
                                   :score-min 0.80}
                           :checks [:schema-valid]
                           :judge {:enabled? false
                                   :intent :eval/grade
                                   :cap/id :llm/judge
                                   :role :router
                                   :max-attempts 1
                                   :score-path [:score]}
                           :retry {:max-attempts 3
                                   :same-cap-max 1
                                   :fallback-max 1}
                           :switch-on #{:schema/invalid :format/drift :eval/low-score}
                           :fallback  [:llm/solver :llm/code :llm/meta :llm/judge :llm/mock]}

  :policy/intents         {:route/decide      {:done {:must #{:schema-valid}
                                                      :score-min 1.0}
                                               :checks [:schema-valid]
                                               :judge {:enabled? false}}
                           :context/summarize {:done {:must #{:schema-valid}
                                                      :score-min 1.0}
                                               :checks [:schema-valid]
                                               :judge {:enabled? false}}
                           :text/respond      {:done {:must #{:schema-valid}
                                                      :should #{:no-hallucinated-apis :no-list-expansion}
                                                      :score-min 0.8}
                                               :checks [:schema-valid :no-hallucinated-apis]
                                               :judge {:enabled? true
                                                       :max-attempts 1}}
                           :problem/solve     {:done {:must #{:schema-valid}
                                                      :should #{:no-hallucinated-apis}
                                                      :score-min 0.8}
                                               :checks [:schema-valid :no-hallucinated-apis]
                                               :judge {:enabled? false}}
                           :code/generate     {:done {:must #{:schema-valid}
                                                      :should #{:tests-pass :no-hallucinated-apis}
                                                      :score-min 0.8}
                                               :checks [:schema-valid :tests-pass]
                                               :judge {:enabled? false}}
                           :code/patch        {:done {:must #{:schema-valid}
                                                      :should #{:tests-pass :no-hallucinated-apis}
                                                      :score-min 0.8}
                                               :checks [:schema-valid :tests-pass]
                                               :judge {:enabled? true
                                                       :max-attempts 1}}
                           :code/explain      {:done {:must #{:schema-valid}
                                                      :should #{:tests-pass :no-hallucinated-apis}
                                                      :score-min 0.8}
                                               :checks [:schema-valid :tests-pass]
                                               :judge {:enabled? false}}
                           :code/review       {:done {:must #{:schema-valid}
                                                      :should #{:tests-pass :no-hallucinated-apis}
                                                      :score-min 0.8}
                                               :checks [:schema-valid :tests-pass]
                                               :judge {:enabled? false}}
                           :eval/grade        {:done {:must #{:schema-valid}
                                                      :score-min 1.0}
                                               :checks [:schema-valid]
                                               :judge {:enabled? false}}}

  :roles                  {:router {:allowed [:route :checks :budget]}
                           :solver {:allowed [:analysis :value :notes]}
                           :coder  {:allowed [:patch :tests :notes]}
                           :voice  {:allowed [:text :summary]}}

  :constraints/default    {:no-web true
                           :language :pl
                           :style :concise}
  :budget/default         {:max-tokens 1200
                           :temperature 0.0
                           :max-roundtrips 3}
  :effects/default        {:allowed #{:none}}

  :error/catalog          {:schema/invalid      {:retryable? true}
                           :format/drift        {:retryable? true}
                           :timeout/soft        {:retryable? true}
                           :eval/low-score      {:retryable? true}
                           :policy/blocked      {:retryable? false}
                           :timeout/hard        {:retryable? false}
                           :input/invalid       {:retryable? false}
                           :unsupported/intent  {:retryable? false}}

  :result/types           [:value :plan :stream :error]
  :retry/max-attempts     3}

}
