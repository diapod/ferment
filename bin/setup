#!/bin/sh
set -eu

case $0 in
  */*) self=$0 ;;
  *)   self=$(command -v -- "$0") || exit 1 ;;
esac

script_dir=$(
  CDPATH= cd -- "$(dirname -- "$self")" 2>/dev/null && pwd -P
) || exit 1
project_root=$(
  CDPATH= cd -- "${script_dir}/.." 2>/dev/null && pwd -P
) || exit 1

absolutize_path() {
  case "$1" in
    /*) printf "%s\n" "$1" ;;
    *)  printf "%s/%s\n" "$project_root" "$1" ;;
  esac
}

PROFILE="${FERMENT_PROFILE:-dev}"

ENVVARS_FILE_PROD="${script_dir}/../resources/config/common/prod/locations.env"
if [ -r "$ENVVARS_FILE_PROD" ]; then
    . "$ENVVARS_FILE_PROD"
fi

if [ "${PROFILE}" != "prod" ]; then
    ENVVARS_FILE="${script_dir}/../resources/config/common/${PROFILE}/locations.env"
    if [ -r "$ENVVARS_FILE" ]; then
        . "$ENVVARS_FILE"
    fi
fi

ENVVARS_FILE_PROD="${script_dir}/../resources/config/local/prod/locations.env"
if [ -r "$ENVVARS_FILE_PROD" ]; then
    . "$ENVVARS_FILE_PROD"
fi

if [ "${PROFILE}" != "prod" ]; then
    ENVVARS_FILE="${script_dir}/../resources/config/local/${PROFILE}/locations.env"
    if [ -r "$ENVVARS_FILE" ]; then
        . "$ENVVARS_FILE"
    fi
fi

: "${HF_HOME:?HF_HOME is not set (expected from locations.env)}"
: "${HF_HUB_CACHE:=${HF_HOME%/}/hub}"
: "${OLLAMA_MODELS:?OLLAMA_MODELS is not set (expected from locations.env)}"

HF_HOME=$(absolutize_path "${HF_HOME}")
HF_HUB_CACHE=$(absolutize_path "${HF_HUB_CACHE}")
OLLAMA_MODELS=$(absolutize_path "${OLLAMA_MODELS}")

export HF_HOME
export HF_HUB_CACHE
export OLLAMA_MODELS

mkdir -p -- "${HF_HOME}"
mkdir -p -- "${HF_HUB_CACHE}"
mkdir -p -- "${OLLAMA_MODELS}"

echo "[ferment] Setting up the environment..."

brew install ollama terminal-notifier pyenv pyenv-ccache clojure
pip install mlx-lm
